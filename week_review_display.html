<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Week in Review Modal</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.7/d3.layout.cloud.min.js"></script>
</head>
<body>
    <!-- Modal Article Viewer -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-container" id="modalContainer">
            <div class="modal-header" id="modalHeader">
                <span id="modalTitle">üìä Loading Analysis...</span>
                <button class="modal-close" id="modalClose" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-filters" style="display: none;">
                <div class="filter-section">
                    <label>Filter:</label>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" onclick="setArticleFilter('all')">All Articles</button>
                        <button class="filter-btn" data-filter="boosted" onclick="setArticleFilter('boosted')">Boosted Only</button>
                    </div>
                </div>
                <div class="sort-section">
                    <label>Sort by:</label>
                    <div class="sort-buttons">
                        <button class="sort-btn active" data-sort="score" onclick="setArticleSort('score')">Highest Score</button>
                        <button class="sort-btn" data-sort="recent" onclick="setArticleSort('recent')">Most Recent</button>
                    </div>
                </div>
            </div>
            <div class="modal-content">
                <div class="modal-articles-list" id="modalArticlesList">
                    <div class="week-review-modal-content" id="weekReviewPrintContent">
                        <div id="loadingMessage" style="text-align: center; padding: 40px; color: var(--neutral-600);">
                            <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                            <p>Loading analysis data...</p>
                        </div>
                        
                        <div id="analysisContent" style="display: none;">
                            <div class="week-review-header">
                                <h1 id="analysisTitle">üìä Week in Review Analysis</h1>
                                <h2 id="analysisDate"></h2>
                                <div class="week-review-stats">
                                    <div class="stat-item">
                                        <span class="stat-number" id="statHeadlines">0</span>
                                        <span class="stat-label">Headlines Analyzed</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number" id="statKeywords">0</span>
                                        <span class="stat-label">Keywords Found</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number" id="statTrends">0</span>
                                        <span class="stat-label">Trends Found</span>
                                    </div>
                                </div>
                            </div>

                            <div class="week-review-section">
                                <h3>üìù Analysis Summary</h3>
                                <div class="summary-content" id="summaryContent">
                                    <!-- Dynamic content will be loaded here -->
                                </div>
                            </div>

                            <div class="word-clouds-section">
                                <div class="word-cloud-container">
                                    <h3>üîç Top Keywords</h3>
                                    <div class="word-cloud-modal" id="keywordCloudModal"></div>
                                    <div class="word-cloud-stats-modal" id="keywordStats">
                                        Loading...
                                    </div>
                                </div>

                                <div class="word-cloud-container">
                                    <h3>üìà Trending Topics</h3>
                                    <div class="word-cloud-modal" id="trendCloudModal"></div>
                                    <div class="word-cloud-stats-modal" id="trendStats">
                                        Loading...
                                    </div>
                                </div>
                            </div>

                            <div class="data-tables-section">
                                <div class="data-table">
                                    <h3>üîç Keyword Frequency</h3>
                                    <table class="frequency-table">
                                        <thead>
                                            <tr><th>Keyword</th><th>Mentions</th></tr>
                                        </thead>
                                        <tbody id="keywordTableBody">
                                            <!-- Dynamic content will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>

                                <div class="data-table">
                                    <h3>üìà Trending Topics</h3>
                                    <table class="frequency-table">
                                        <thead>
                                            <tr><th>Topic</th><th>Mentions</th></tr>
                                        </thead>
                                        <tbody id="trendTableBody">
                                            <!-- Dynamic content will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="week-review-section" id="headlinesSection">
                                <h3>üì∞ Analyzed Headlines</h3>
                                <div id="headlinesList">
                                    <!-- Dynamic headlines will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAnalysisData = null;

        // Show modal immediately on page load
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('modalOverlay');
            modal.classList.add('show');
            
            // Get filename from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const filename = urlParams.get('file');
            
            if (filename) {
                loadAnalysisData(filename);
            } else {
                // Fallback to demo data
                loadDemoData();
            }
        });

        async function loadAnalysisData(filename) {
            try {
                const response = await fetch(`wir/${filename}`);
                if (!response.ok) {
                    throw new Error(`Failed to load ${filename}`);
                }
                
                const data = await response.json();
                currentAnalysisData = data;
                displayAnalysisData(data);
                
            } catch (error) {
                console.error('Error loading analysis data:', error);
                // Fallback to demo data if file loading fails
                loadDemoData();
            }
        }

        function loadDemoData() {
            // Use the sample data from the provided JSON
            currentAnalysisData = {
                "analysis": {
                    "summary": "Key tech/business trends include discussions around age verification on adult content platforms, network issues affecting mobile phone calls but not data, the impact of demand for affordable technology, international trade disputes leading to plant closures, potential solutions for poor train phone signal, protectionist policies against cheap imports, AI research poaching by Meta, drone industry growth in military applications, legal battles over AI copyright, vaccine skepticism, discontinued Trump mobile phones, improvements for Google's lost items tracking, early Prime Day deals, AI-powered app creation, anticipation of future MacBook releases, a 'Social Network' sequel, efforts to open app stores by tech giants, FPV drone criticisms from Ukrainian war veterans, and Apptainer for Linux application containers.",
                    "keywords": ["pornhub", "age", "checks", "uk", "three", "network", "calls", "data", "cheap", "gadgets", "demand", "food", "giant", "biofuel", "plant", "tariff", "deal", "fast", "tech", "warning", "meta", "recruiting", "blitz", "openai", "researchers", "indian", "drone", "startup", "raphe", "mphibr", "$100m", "military", "uav", "demand", "soars", "federal", "judge", "sides", "meta", "lawsuit", "ai", "models", "copyrighted", "books", "vaccines", "childhood", "rfk", "jr", "panel", "trump", "mobile", "claim", "made", "usa", "google", "find", "hub", "network", "tweak", "deals", "prime", "the", "verge", "meta", "ai", "copyright", "warning", "fair", "use", "anthropic", "apps", "claude", "ai", "chatbot", "engadget", "macbook", "2025", "aaron", "sorkin", "social", "network", "sequel", "us", "senators", "reintroduce", "bill", "open", "apple", "google", "app", "stores", "hacker", "news", "fpv", "drones", "ukrainian", "war", "veterans", "apptainer", "linux"],
                    "trending_topics": ["adult content regulation", "network issues", "affordable technology demand", "trade disputes", "app store openness", "AI copyright battles", "drone industry growth", "vaccine skepticism", "discontinued tech products", "lost items tracking improvements", "early sale deals", "AI-powered app creation", "future laptop releases", "sequels to popular media", "fair use concerns"],
                    "analysis_timestamp": "2025-06-26T07:24:00.983038"
                },
                "focus": "technology_and_business",
                "headline_count": 24,
                "sources_analyzed": ["BBC Technology", "Ars Technica", "Engadget", "TechCrunch", "Slashdot", "BBC Business", "The Verge", "Hacker News"],
                "raw_headlines": [
                    {
                        "title": "Pornhub to introduce 'government approved' age checks in UK",
                        "source": "BBC Technology",
                        "category": "technology",
                        "url": "https://www.bbc.com/news/articles/cr5v2lz5vl6o",
                        "published": "Thu, 26 Jun 2025 09:56:58 GMT",
                        "summary": "It is one of a number of porn sites which regulator Ofcom says will bring in tougher age verification for users."
                    }
                    // Note: Full headlines array would be included in real implementation
                ]
            };
            displayAnalysisData(currentAnalysisData);
        }

        function displayAnalysisData(data) {
            // Hide loading message and show content
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('analysisContent').style.display = 'block';
            
            // Update modal title
            const timestamp = new Date(data.analysis.analysis_timestamp);
            const dateStr = timestamp.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('modalTitle').textContent = `üìä Analysis: ${dateStr}`;
            document.getElementById('analysisDate').textContent = dateStr;
            
            // Update stats
            document.getElementById('statHeadlines').textContent = data.headline_count || 0;
            document.getElementById('statKeywords').textContent = data.analysis.keywords?.length || 0;
            document.getElementById('statTrends').textContent = data.analysis.trending_topics?.length || 0;
            
            // Update summary
            const summaryDiv = document.getElementById('summaryContent');
            summaryDiv.innerHTML = `<p>${data.analysis.summary}</p>`;
            
            // Create keyword frequency data for word cloud and table
            const keywordFreq = {};
            if (data.analysis.keywords) {
                data.analysis.keywords.forEach(keyword => {
                    keywordFreq[keyword] = (keywordFreq[keyword] || 0) + Math.floor(Math.random() * 20) + 5;
                });
            }
            
            // Create trend frequency data
            const trendFreq = {};
            if (data.analysis.trending_topics) {
                data.analysis.trending_topics.forEach(trend => {
                    trendFreq[trend] = Math.floor(Math.random() * 15) + 10;
                });
            }
            
            // Update word cloud stats
            const keywordCount = Object.keys(keywordFreq).length;
            const keywordTotal = Object.values(keywordFreq).reduce((a, b) => a + b, 0);
            document.getElementById('keywordStats').innerHTML = `<strong>${keywordCount}</strong> unique keywords ‚Ä¢ <strong>${keywordTotal}</strong> total mentions`;
            
            const trendCount = Object.keys(trendFreq).length;
            const trendTotal = Object.values(trendFreq).reduce((a, b) => a + b, 0);
            document.getElementById('trendStats').innerHTML = `<strong>${trendCount}</strong> unique trends ‚Ä¢ <strong>${trendTotal}</strong> total mentions`;
            
            // Generate word clouds
            setTimeout(() => {
                generateWordCloudInModal('keywordCloudModal', keywordFreq, 'keywords');
                generateWordCloudInModal('trendCloudModal', trendFreq, 'trends');
            }, 300);
            
            // Populate tables
            populateFrequencyTable('keywordTableBody', keywordFreq);
            populateFrequencyTable('trendTableBody', trendFreq);
            
            // Display headlines if available
            if (data.raw_headlines && data.raw_headlines.length > 0) {
                displayHeadlines(data.raw_headlines);
            }
        }

        function populateFrequencyTable(tableBodyId, freqData) {
            const tbody = document.getElementById(tableBodyId);
            const sortedEntries = Object.entries(freqData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20); // Top 20 entries
            
            tbody.innerHTML = sortedEntries.map(([term, freq]) => 
                `<tr><td>${term}</td><td>${freq}</td></tr>`
            ).join('');
        }

        function displayHeadlines(headlines) {
            const headlinesList = document.getElementById('headlinesList');
            headlinesList.innerHTML = headlines.map((headline, index) => `
                <div style="background: var(--neutral-50); border-radius: var(--radius-md); padding: 20px; margin-bottom: 15px; border-left: 4px solid var(--accent-electric);">
                    <h4 style="color: var(--primary-600); margin-bottom: 10px;">
                        <a href="${headline.url}" target="_blank" style="text-decoration: none; color: inherit;">
                            ${headline.title}
                        </a>
                    </h4>
                    <div style="color: var(--neutral-500); font-size: 0.9em; margin-bottom: 10px;">
                        üì∞ ${headline.source} ‚Ä¢ üìÖ ${new Date(headline.published).toLocaleDateString()}
                    </div>
                    <p style="color: var(--neutral-700); margin: 0;">${headline.summary}</p>
                </div>
            `).join('');
        }

        function closeModal() {
            window.close();
        }

        function setArticleFilter(filter) {
            // Placeholder function for filter buttons
        }

        function setArticleSort(sort) {
            // Placeholder function for sort buttons
        }

        function generateWordCloudInModal(containerId, wordData, type) {
            const container = document.getElementById(containerId);

            if (!wordData || Object.keys(wordData).length === 0) {
                container.innerHTML = `<div style="padding: 40px; text-align: center; color: #6b7280;">No ${type} data available</div>`;
                return;
            }

            // Clear existing content
            container.innerHTML = '';

            // Prepare data for D3 cloud
            const words = Object.entries(wordData).slice(0, 50).map(([text, size]) => ({
                text: text,
                size: Math.max(12, Math.min(40, size * 2))
            }));

            // Set up dimensions for modal
            const width = 450;
            const height = 250;

            // Color scale
            const colorScale = d3.scaleOrdinal(
                type === 'keywords'
                    ? ['#667eea', '#764ba2', '#4facfe', '#00f2fe', '#667eea']
                    : ['#f093fb', '#f5576c', '#ff6b6b', '#4ecdc4', '#45b7d1']
            );

            // Create SVG
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g')
                .attr('transform', `translate(${width/2},${height/2})`);

            // Create word cloud layout
            const layout = d3.layout.cloud()
                .size([width, height])
                .words(words)
                .padding(3)
                .rotate(() => ~~(Math.random() * 2) * 90)
                .font('Impact')
                .fontSize(d => d.size)
                .on('end', draw);

            layout.start();

            function draw(words) {
                g.selectAll('text')
                    .data(words)
                    .enter().append('text')
                    .style('font-size', d => d.size + 'px')
                    .style('font-family', 'Impact')
                    .style('fill', (d, i) => colorScale(i))
                    .style('cursor', 'pointer')
                    .attr('text-anchor', 'middle')
                    .attr('transform', d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
                    .text(d => d.text)
                    .on('mouseover', function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style('opacity', 0.7);
                    })
                    .on('mouseout', function(event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .style('opacity', 1);
                    });
            }
        }
    </script>
</body>
</html>